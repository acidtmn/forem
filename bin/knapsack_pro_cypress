#!/usr/bin/env ruby
require "cypress-rails"
require Pathname.new(CypressRails::Config.new.dir).join("config/environment")

module CypressRails
  class FindsBin
    def call(dir = Dir.pwd)
      "node_modules/.bin/knapsack-pro-cypress"
    end
  end
end

CypressRails::FindsBin

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

ENV["E2E"]="true"
if !!ENV["KNAPSACK_PRO_TEST_SUITE_TOKEN_CYPRESS"]
  CypressRails::Run.new.call
else
  ENV["KNAPSACK_PRO_ENDPOINT"] = "https://api-disabled-for-fork.knapsackpro.com"
  ENV["KNAPSACK_PRO_MAX_REQUEST_RETRIES"] = "0"
  ENV["KNAPSACK_PRO_TEST_SUITE_TOKEN_CYPRESS"] = "disabled-for-fork"
  CypressRails::Run.new.call
end
