<% decorated_comment = comment.decorate %>
<% color = HexComparer.new([user_colors(comment.user)[:bg], user_colors(comment.user)[:text]]).brightness(0.88) %>
<% if true %>
<li
  class="
    comment
    <%= comment_class(comment, is_view_root: is_view_root) %>
    <%= "flat-node" if comment.depth > 3 %>
    comment-deep-<%= comment.depth %>
  "
  id="comment-node-<%= comment.id %>"
  data-comment-id="<%= comment.id %>"
  data-comment-author-id="<%= comment_user_id_unless_deleted comment %>"
  data-content-user-id="<%= comment_user_id_unless_deleted comment %>">
  <header class="comment__header">
    <% if comment.deleted %>
      Comment deleted...
    <% else %>
      <a href="/<%= comment.user.username %>" class="flex items-center mr-2" title="<%= comment.user.name %> profile">
        <span class="crayons-avatar mr-1 m:mr-2 shrink-0">
          <img src="<%= Images::Profile.call(comment.user.profile_image_url, length: 50) %>" width="32" height="32" class="crayons-avatar__image" alt="<%= comment.user.name %> profile image">
        </span>
        <strong class="fw-medium"><%= comment.user.name %></strong>

        <% if commentable_author_is_op?(commentable, comment) %>
          <span class="crayons-indicator crayons-indicator--accent ml-2"><%= get_ama_or_op_banner(commentable) %></span>
        <% end %>
      </a>

      <%= render "comments/comment_date", decorated_comment: decorated_comment %>

      <div class="ml-auto relative -my-1 m:-my-2 comment__dropdown">
        <button type="button" class="crayons-btn crayons-btn--ghost crayons-btn--icon comment__dropdown__trigger dropbtn" aria-label="Toggle dropdown menu">
          <%= inline_svg_tag("overflow-horizontal.svg", class: "crayons-icon pointer-events-none") %>
        </button>
        <div class="dropdown">
          <div class="crayons-dropdown p-1 z-30 right-1 left-1 s:right-0 s:left-auto fs-base">
            <a href="<%= comment.path %>" class="crayons-link crayons-link--block">Permalink</a>
            <span class="comment-actions hidden" data-user-id="<%= comment.user_id %>" data-action="settings-button" data-path="<%= comment.path %>/settings">
            </span>
            <% action = comment.hidden_by_commentable_user ? "Unhide" : "Hide" %>
            <span class="comment-actions hidden" data-action="hide-button" data-commentable-user-id="<%= commentable.user_id %>" data-user-id="<%= comment.user_id %>" style="display: none; width: 100%;">
              <a href="#" class="crayons-link crayons-link--block hide-comment" data-hide-type="<%= action.downcase %>" data-comment-id="<%= comment.id %>">
                <%= action %>
              </a>
            </span>
            <span class="mod-actions hidden mod-actions-comment-button" data-path="<%= comment.path %>/mod"></span>
            <span class="report-abuse-link-wrapper" data-path="/report-abuse?url=<%= comment_url(comment) %>"></span>
            <span class="current-user-actions hidden"></span>
          </div>
        </div>
      </div>
    <% end %>
  </header>
  <div class="comment__body">
    <button class="comment__toggle" style="--comment-brand-hover-color: <%= color %>">
      <span class="comment__toggle__icon">
        <%= inline_svg_tag("collapse.svg", class: "crayons-icon") %>
      </span>
      <span class="comment__toggle__stripe"></span>
    </button>

    <div class="comment__main">
      <% if comment.deleted %>
        ...
      <% else %>
        <div class="comment__content text-styles text-styles--comment">
          <% if decorated_comment.low_quality %>
            <p>Comment marked as low quality/non-constructive by the community. <a href="/code-of-conduct">View code of conduct</a>.</p>
          <% end %>

          <% if comment.hidden_by_commentable_user %>
            <p>Comment hidden by post author - thread only visible in this permalink</p>
          <% end %>

          <%= comment.safe_processed_html %>
        </div>

        <footer class="comment__footer" data-comment-id="<%= comment.id %>" data-path="<%= commentable.path %>/comments/<%= comment.id_code_generated %>">
          <button class="reaction-button crayons-reactions mr-2 -ml-1" type="button" id="button-for-comment-<%= comment.id %>" data-comment-id="<%= comment.id %>">
            <span class="crayons-reactions__icons">
              <span class="crayons-reactions__icon">
                <%= inline_svg_tag("heart.svg", aria: true, width: 16, height: 16, class: "crayons-icon inactive", title: "Like") %>
                <%= inline_svg_tag("heart-filled.svg", aria: true, width: 16, height: 16, class: "crayons-icon active", title: "Like") %>
              </span>
            </span>
          </button>

          <a href="#<%= commentable.path %>/comments/new/<%= comment.id_code_generated %>" class="crayons-reactions toggle-reply-form <% unless comment.depth < 2 || is_childless %>thread-indication<% end %>" rel="nofollow">
            <span class="crayons-reactions__icons">
              <span class="crayons-reactions__icon crayons-reactions__icon--comment">
                <%= inline_svg_tag("comment.svg", aria: true, width: 16, height: 16, class: "crayons-icon", title: "Comment") %>
              </span>
            </span>
            <span class="crayons-reactions__label">
              <% if comment.depth < 2 || is_childless %>
                Reply
              <% else %>
                Thread
              <% end %>
            </span>
          </a>
        </footer>
      <% end %>

      <%= subtree_html %>
    </div>
  </div>
</li>

<% else %>
  <div id="comment-node-<%= comment.id %>" class="single-comment-node <%= comment_class(comment, is_view_root: is_view_root) %> <%= "flat-node" if comment.depth > 3 %> comment-deep-<%= comment.depth %>" data-comment-id="<%= comment.id %>" data-comment-author-id="<%= comment_user_id_unless_deleted comment %>" data-content-user-id="<%= comment_user_id_unless_deleted comment %>">
    <% if comment.deleted %>
      <div class="inner-comment">
        <div class="body" style="padding-bottom:32px;opacity:0.3;user-select:none;cursor:default">
          [deleted]
        </div>
      </div>
    <% else %>
      <div class="inner-comment">
        <% decorated_comment = comment.decorate %>

        <% if decorated_comment.low_quality %>
          <div class="low-quality-comment-marker">
            <%= image_tag(Images::Optimizer.call(SiteConfig.mascot_image_url,
                                                 type: "fetch",
                                                 width: 50,
                                                 height: 50,
                                                 crop: "imagga_scale",
                                                 quality: "auto",
                                                 flags: "progressive",
                                                 fetch_format: "auto",
                                                 sign_url: true), class: "sloan", alt: "Sloan, the sloth mascot", loading: "lazy") %>
            Comment marked as low quality/non-constructive by the community
            <a href="/code-of-conduct">View code of conduct</a>
          </div>
        <% end %>
        <% if comment.hidden_by_commentable_user %>
          <div class="low-quality-comment-marker">
            Comment hidden by post author - thread only visible in this permalink
          </div>
        <% end %>

        <!-- TODO: low-quality-comment --><div class="details <%= "low-quality-comment" if decorated_comment.low_quality %>">
          <a href="/<%= comment.user.username %>">
            <img class="profile-pic" src="<%= ProfileImage.new(comment.user).get(width: 50) %>" alt="<%= comment.user.username %> profile image" />
            <span class="comment-username">
              <span class="comment-username-inner">
                <%= comment.user.name %>
              </span>
            </span>
          </a>

          <%= render "comments/comment_date", decorated_comment: decorated_comment %>

        </div>

        <!-- TODO: low-quality-comment --><div class="body <%= "low-quality-comment" if decorated_comment.low_quality %>">
          <%= comment.safe_processed_html %>
          <button class="reaction-button" id="button-for-comment-<%= comment.id %>" data-comment-id="<%= comment.id %>" title="heart">
            <%= image_tag("favorite-heart-outline-button.svg", alt: "Favorite heart outline button") %>
            <img class="voted-heart" src="<%= asset_path("emoji/emoji-one-heart.png") %>" alt="Favorite heart button" />
          </button>
        </div>
        <div class="actions" data-comment-id="<%= comment.id %>" data-path="<%= commentable.path %>/comments/<%= comment.id_code_generated %>">
          <span class="current-user-actions hidden" style="display:none">
          </span>
        </div>
      </div>
    <% end %>
    <%= subtree_html %>
  </div>
<% end %>
