<h1>Classified Listings</h1>
<%= form_tag("/internal/listings", method: "get") do %>
  <%= label_tag(:search, "Find by listing title or username:") %>
  <%= text_field_tag(:search, params[:search]) %>
  <% if params[:state].present? %>
    <%= hidden_field_tag(:state, params[:state]) %>
  <% end %>
  <%= label_tag(:search, "Filter listings by category") %>
  <%= select_tag(:filter, options_for_select( [""] + ClassifiedListing.categories_available.keys, params[:filter])) %>
  <%= submit_tag("Search & Filter") %>
<% end %>
<%= paginate @classified_listings %>
<div class="wrapper" style="border-bottom: 1px solid black">
  <div class="grid-item">Title Link</div>
  <div class="grid-item">User/Org</div>
  <div class="grid-item">Category</div>
  <div class="grid-item">Cached Tags</div>
  <div class="grid-item">Published?</div>
  <div class="grid-item">Last Bumped</div>
</div>
<% @classified_listings.each do |listing| %>
  <% previous_emails = @email_messages.where(listing_id: listing.id) %>
  <div class="single-internal-listing">
    <div class="wrapper">
      <div class="grid-item">
        <a href="/internal/listings/<%= listing.id %>/edit" target="_blank">
          <%= listing.title %>
        </a>
      </div>
      <div class="grid-item"><a href="/internal/users/<%= listing.user_id %>"><%= User.find(listing.user_id).username %></a><%= " / " + Organization.find(listing.organization_id).name if listing.organization_id.present? %></div>
      <div class="grid-item"><%= listing.category %></div>
      <div class="grid-item"><%= listing.cached_tag_list %></div>
      <div class="grid-item"><%= listing.published ? "Yes" : "No" %></div>
      <div class="grid-item"><%= listing.bumped_at ? time_ago_in_words(listing.bumped_at) + " ago" : "Draft" %></div>
    </div>
    <div class="buffer-area" style="text-align: left">
      <br>
      <button class="btn toggle-buffering-butt" style="border: 1px solid grey; margin-top: 2px">Share to Buffer</button><% if listing.last_buffered.present? %> <em> Last shared: <%= listing.last_buffered.strftime("%d %B %Y") %></em><% end %>
      <br>
      <br>
      <div class="buffering-area-for-single-listing" style="display: none;">
        <div class="grid-item">
          <p class="listing-title"><strong><%= listing.title %></strong></p>
          <p class="listing-body"><%= listing.processed_html&.html_safe %></p>
        </div>
        <div class="grid-item">
          <%= form_tag "/internal/buffer_updates" do %>
            <input type="hidden" name="social_channel" value="listings_twitter" />
            <input type="hidden" name="listing_id" value="<%= listing.id %>" />
            <textarea cols="37" rows="8" wrap="hard" name="tweet" maxlength="255">📋 New DEV Listing!&#013&#013Category: <%= listing.category %>&#013&#013<%= listing.title %>&#013&#013<% if listing.user.twitter_username? %>Posted by @<%= listing.user.twitter_username %><% end %></textarea>
            <br>
            <button class="btn-info tweet-listing">🐦 Tweet 🐦</button>
          <% end %>
        </div>
      </div>
    </div>

    <h3>Email Form:</h3>
    <div class="email-area" style="text-align:left">
      <h3>
        Send to:
        <br>
        <%= email_field_tag :reporter_email_to, listing.user.email, class: "form-control", id: "reporter__emailto__#{listing.id}", required: true %>
      </h3>
      <h3>Subject:</h3>
      <%= text_field_tag :reporter_email_subject, "Regarding your recent DEV Listing", class: "form-control", id: "reporter__subject__#{listing.id}" %>
      <h3>Body:</h3>
      <%= text_area_tag :reporter_email_body, listing.title, class: "form-control", style: "height: 200px;", id: "reporter__body__#{listing.id}" %>
    </div>
    <br>
    <button class="btn btn-primary" type="button" id="send__email__btn__<%= listing.id %>">SEND EMAIL ✉️</button>
    <div class="email__alert alert fade in" id="email__alert__<%= listing.id %>">
    </div>
  </div>

<script>
  function successfulEmail(alert) {
    alert.style.display = 'inline-block';
    alert.classList.add('alert-success');
    alert.innerHTML = "Email sent successfully! Refresh to see";
  }

  function failedEmail(alert) {
    alert.style.display = 'inline-block';
    alert.classList.add('alert-danger');
    alert.innerHTML = "Email failed to send, see console or airbrake for errors";
  }

  function sendEmail(id) {
    var alert = document.getElementById('email__alert__' + id);
    var sendEmailBtn = document.getElementById('send__email__btn__' + id);
    var emailToAddress = document.getElementById('reporter__emailto__' + id).value;
    var subjectLine = document.getElementById('reporter__subject__' + id).value;
    var emailBody = document.getElementById('reporter__body__' + id).value;

    alert.style.display = "none";
    alert.classList.remove("alert-warning");
    alert.classList.remove("alert-success");
    alert.classList.remove("alert-danger");

    if (emailToAddress === "") {
      alert.style.display = 'inline-block';
      alert.classList.add("alert-warning");
      alert.innerHTML = "Email can't be blank!"
      return
    }

    var formData = new FormData();
    formData.append('listing_id', id);
    formData.append('email_to', emailToAddress);
    formData.append('email_body', emailBody);
    formData.append('email_subject', subjectLine);
    formData.append('email_type', "Listing");

    fetch('/internal/reports/send_email', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector("meta[name='csrf-token']").content,
      },
      body: formData,
      credentials: 'same-origin'
    })
      .then(response => response.json()
        .then(json => {
          if (json.outcome === "Success") {
            successfulEmail(alert);
          } else {
            console.log('email failed')
            failedEmail(alert);
          }
        }))
      .catch(error => {
        failedEmail(alert);
        console.log(error);
      })
  }

  document.getElementById('send__email__btn__' + <%= listing.id %>).addEventListener('click', function (event) {
    event.preventDefault();
    var reportId = <%= listing.id %>;
    sendEmail(reportId);
  });
</script>
<% end %>


<%= paginate @classified_listings %>
<%= render "internal/articles/article_script" %>